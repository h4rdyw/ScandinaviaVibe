{% comment %}theme-check-disable{% endcomment %}
{{ 'product.css' | asset_url | stylesheet_tag }}

<script>   
    window.addEventListener('load', 
        function() { 
          checkLocaleBtn();         
        }, false);
</script>

{% assign current_product = product.selected_or_first_available_variant %} 
{% assign product_image = current_product.featured_image | default: product.featured_image %}
{% assign product_short_description = product.description | truncatewords: 15, '...' %}
      {% assign product_descriptions = product.description | split: '$$$$$$' %}

      {% assign product_descriptions_length = product_descriptions.size %}

      {% if product_descriptions_length > 1 %}
        {% assign product_short_description = product_descriptions[0] %}
        {% assign product_description = product_descriptions[1] %}
     {% else %}
        {% assign product_description = product.description %}    
      {% endif %}    

<div class="container" id="product_details">
    <div class="row flex-column-reverse flex-lg-row py-5">
        <div class="d-flex flex-fill flex-column col-lg-8 col-md-12 col-12">
            {% comment %} <img class="img-fluid"
                src="{{ product_image | img_url: 'large' }}" alt="{{ product_image.alt }}"  id="{{ product_image.alt }}"/>
                {% for image in product.images %} 
                <img src="{{ image.src | img_url: 'medium' }}" alt="{{ image.alt }}"> 
                {% endfor%} {% endcomment %}
            {% comment %} {% render 'product-image-slider' %} {% endcomment %}
              <div class="d-flex flex-fill swiper-container swiper-container-{{- product.id -}}">
                <div class="swiper-wrapper flex-fill">
                  {% if product.images.size > 1  %}
                    {% assign imgnum = 'true' %}
                  {% endif %}
                  


                  {% for image in product.images %}            
                    <div class="swiper-slide">
                      <img src="{{ image.src | img_url: 'master' }}" alt="{{ image.alt | escape }}" width="640" height="360" loading="lazy"/>

                      {% if imgnum == 'true' %}                       
                      
                      <div class="swiper-button-prev swiper-button-prev-{{- product.id -}}"></div>                     
                      <div class="swiper-button-next swiper-button-next-{{- product.id -}}"></div>

                    {% endif %}

                    </div>          
                  {% endfor %}    
                </div>
              </div>
              <p span class="text-line"></p>
              <div class="text-product-desc"><p>{{ product_description }}</p></div>
        </div>
        
        <div class="d-flex flex-column flex-fill col-lg-4 col-md-12 col-12">
            <h1 class="text-product-title">{{ product.title }}</h1>
            <p class="text-header-title">{{ current_product.price | money_without_trailing_zeros }}</p>

            {% form 'product', product, class:"product-form, id:"AddToCartForm %}
                <div class="mb-3">
                    <select name="id" id="productSelect" class="form-select">
                        {% assign availability_count = 0 %}    

                        {% for variant in product.variants %}
                            {% if variant.available %}
                                {% assign availability = availability_count | plus: 1 %}
                                <option value="{{ variant.id }}"> {{ variant.title }} {{ variant.price | money_without_trailing_zeros}}</option>
                            {% else %}
                                <option value="{{ variant.id }}" disabled="disabled"> {{ variant.title }}</option>
                            {% endif %}                       
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <input type="number" class="form-control" name="quantity" id="Quantity" value="1" min="1">
                </div>
                <button type="submit" name="add" id="AddToCart" class="btn-add-to-cart w-100" {% unless availability > 0 %} disabled="disabled" >Sold Out {% else %} >Add to Cart {% endunless %}</button>
                <p></p>
                {% if section.settings.dynamic_button_checkbox== true %}                
                {{ form  | payment_button }}
                {% endif %}
              {% endform %}  
        </div>
      </div>
</div>

<!-- / element structure
<div id="product_recomm" class="container">
    <section id="product_recommendation" class="row content-justify-center my-5">
        <div class="text-center"><h1>Also in store</h1></div>
        <div class="row d-flex g-3 row-cols-lg-6 row-cols-md-4 row-cols-sm-3 row-cols-2 py-2" id="product_recommendation_body"></div>
    </section>
</div> 
/-->

<div class="modal fade" id="productInfoModal" tabIndex="-1" aria-hidden="true" style="z-index:2000">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: none;">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                      <div class="col-12 col-md-6">
                        <img class="img-fluid" style="max-height: 50vh;" src="" id="productInfoImg" alt="">
                      </div>
                      <div class="col-12 col-md-6">
                        <h1 id="productInfoTitle" class="text-product-title"></h1>
                        <p class="text-header-title" id="productInfoPrice" class="text-product-desc"></p>
                        <p id="productInfoDescription" class="text-product-desc"></p>
                      </div>
                </div>             
            </div>
            <div class="modal-footer" style="border-top: none;">
              <div class="col-12 col-md-6"></div>
              <div class="col-12 col-md-6 px-2">
                <form action="#" id="addToCartForm" class="row">
                  <select name="id" id="modalItemID" class="form-select col-auto">
                  </select>
                  <p></p>
                  <div>
                    <input type="number" name="quantity" value="1" id="modalItemQuantity" min="1" max="9999" class="col-auto w-100">    
                    <p></p>           
                    <button type="submit" id="btnAddToCart" class="btn-add-to-cart col-auto w-100">Add to Cart</button>                
                  </div>                
                  <p></p>
                </form>
              </div>
            </div>
        </div>
    </div>
</div>

<style>
  input {
    border-left: none !important;
    border-right: none !important;
    border-top: none !important;
    border-bottom: 1px solid #ced4da !important;
  }
  
  .form-select {
      border-left: none;
      border-right: none;
      border-top: none;
  }  
</style>

<script>  
new Swiper(".swiper-container-{{- product.id -}}", {
    slidesPerView: 1,
    centeredSlides: true,
    effect: "fade",
    loop: true,
    observer: true, 
    observeParents: true,  
    navigation: {
      prevEl: ".swiper-button-prev-{{- product.id -}}",
      nextEl: ".swiper-button-next-{{- product.id -}}"
    }    
  })
  
    //var productRecommendationBody = document.getElementById('product_recommendation_body');
    fetch('/recommendations/products.json?product_id={{ product.id }}')
    .then(resp => resp.json())
    .then(({ products }) =>{
        
        var arrProducts = Array.from(products);
        //console.log(arrProducts);
        //add eventlistener, later to be dispatched when new element build (product recommendation) completed
        arrProducts.forEach( function (el) {
            //console.log(el);
            document.addEventListener( 'dispatchPrd', function ( event ) {
                //console.log(`registering productInfoAnchor ${el.id}`);
                getProductAnchors(`productInfoAnchor-${el.id}`);
              });
        })
               
        //console.log(products);
        if(products.length > 0) {
        
            /* element 
                <div class="container">
                    <section id="product_recommendation" class="row content-justify-center my-5">
                        <div class="text-center"><h1>Also in store</h1></div>
                        <div class="row d-flex g-3 row-cols-lg-6 row-cols-md-4 row-cols-sm-3 row-cols-2 py-2" id="product_recommendation_body"></div>
                    </section>
                </div>
            */

            const htmlMarkup = `
                 <section id="product_recommendation" class="row content-justify-center my-5">
                    <div class="text-center"><h1>Also in store</h1></div>
                    <div class="row d-flex flex-wrap g-3 row-cols-xl-4 row-cols-lg-3 row-cols-md-2 row-cols-sm-1 row-cols-1 py-2" id="product_recommendation_body">
            `;

            html = htmlMarkup.trim();

            var productRecomm = document.createElement('div');
            productRecomm.className = 'container';
            
            products.forEach(function(item,index) {

            //console.log(item);
            arrProducts[item] = `productInfoAnchor-${item.id}`;
            let prdPrice = formatCcy((+item.price / 100));                   
            
            var card;
            card = `<div class="col d-flex">`;
            card += `<div class="img-wrapper d-flex">`;
            card += `<div class="card d-flex flex-fill border-0 shadow-sm">`;

            if(item.images.length > 0) {
                card += `<div class="inner-img">`;
                card += `<a href="#"   id="productInfoAnchor-${item.id}" product-handle="${item.handle}" 
                        product-price="${prdPrice}"><img class="card-img-top" width="640" height="360" src="${item.images[0]}"></a>`;
                card += `<div class="text-hover">BUY NOW</div></div>`;
            }          
            card += `<div class="card-body d-flex flex-column justify-content-end text-center bg-light">`;
            card += `<a class="text-product-link" style="font-size:1.25rem;" href="${item.url}">${item.title}</a>`;
            card += `<p span class="text-line"></p>`;
            card += `<p>${prdPrice}</p>`;
            card += `</div></div></div></div>`;
            
            html += card;                           

        });
        
        html += `</div></section>`;

        productRecomm.innerHTML = html;  
         
        //insert element after "product_details"
        const reference = document.getElementById("product_details");        
        reference.after(productRecomm);

        // Create a custom event and dispatch to setup PopUp Modal 
        let myEvent = new CustomEvent('dispatchPrd', {
	        bubbles: true,
	        cancelable: true
            });
        setTimeout(()=>{
            const body = document.body;
            document.dispatchEvent(myEvent);
        },2)
        clearTimeout();        
        }            
    });
       
     function formatCcy(amount) {
        var ccyTemp = parseFloat(amount).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
      
        //remove trailing zeros
        var ccyFormated =
          ccyTemp.slice(-3) === '.00'
            ? ccyTemp.slice(0, -3)
            : ccyTemp.slice(-1) === '0'
            ? ccyTemp.slice(0, -1)
            : ccyTemp;
        return ccyFormated;
      }
</script>

{% schema %}
{
    "name": "product pages",
    "settings": [
    {
        "type": "checkbox",
        "id": "dynamic_button_checkbox",
        "label": "Enable Dynamic Buy Button",
        "default": false
    }]
}
{% endschema %}


 
{% comment %}theme-check-enable{% endcomment %}
