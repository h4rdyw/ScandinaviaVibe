{% comment %}theme-check-disable{% endcomment %}
{{ 'product.css' | asset_url | stylesheet_tag }}

{% assign current_product = product.selected_or_first_available_variant %} 
{% assign product_image = current_product.featured_image | default: product.featured_image %}

    {% for tag in product.tags %}
       {% if tag contains 'Special' %}
        {% assign specialbox = 'true' %}
      {% endif %}    
      {% if tag contains 'Award' %}
          {% assign awardbox = 'true' %}
      {% endif %}   
    {% endfor %}
     
<section class="container py-5" id="product_details">
  <p></p>
    <div class="row flex-column-reverse flex-lg-row">
        <div class="d-flex flex-fill flex-column col-lg-8 col-md-12 col-12">
            {% comment %} <img class="img-fluid"
                src="{{ product_image | img_url: 'large' }}" alt="{{ product_image.alt }}"  id="{{ product_image.alt }}"/>
                {% for image in product.images %} 
                <img src="{{ image.src | img_url: 'medium' }}" alt="{{ image.alt }}"> 
                {% endfor%} {% endcomment %}
            {% comment %} {% render 'product-image-slider' %} {% endcomment %}
              <div class="d-flex flex-fill swiper-container swiper-container-{{- product.id -}}">
                <div class="swiper-wrapper flex-fill">
                  {% if product.images.size > 1  %}
                    {% assign imgnum = 'true' %}
                  {% endif %}
                  


                  {% for image in product.images %}            
                    <div class="swiper-slide">
                      <img src="{{ image.src | img_url : 'master' }}" alt="{{ image.alt | escape }}" width="480" height="480" loading="lazy"/>

                      {% if imgnum == 'true' %}                       
                      
                      <div class="swiper-button-prev swiper-button-prev-{{- product.id -}}"></div>                     
                      <div class="swiper-button-next swiper-button-next-{{- product.id -}}"></div>

                    {% endif %}

                    </div>          
                  {% endfor %}    
                </div>
              </div>
              <p span class="text-line"></p>
              <div class="text-product-desc"><p>{% render 'product-description' ,product:product, type: 'long' %}</p></div>
        </div>
        
        <div class="d-flex flex-column flex-fill col-lg-4 col-md-12 col-12">
          <h1 class="text-product-title">{{ product.title }} </h1>

          <div class="px-0 pb-2 mx-0 d-flex flex-row">
            {% if specialbox == 'true' %}      
                   {% assign specialbox = 'false' %}              
                   {% assign iconstyle = 'style="position:relative;left:1px;"' %} 
                   <svg class="star-badge px-0 mx-0" style="position:relative;left:0px !important;">{% render 'star-badge' %}</svg>  
            {% else %}
                   {% assign iconstyle = 'style="position:relative;margin:auto;transform:translateX(-40px);"' %} 
            {% endif %} 

            {% if awardbox == 'true' %}    
                {% assign awardbox = 'false' %}                
                <svg class="award-badge px-0 mx-0" {{ iconstyle }}>{% render 'award-badge' %}</svg>  
            {% endif %} 
            </div>          
            
            <p id="prd-title" class="text-header-title">
              {% if product.compare_at_price_max > 0 %}
                {% render 'discount', product : product %}<svg class="tag-badge">{% render 'tag-badge' %} </svg>
                <del><span style="color: #AB0000;">{{ product.compare_at_price_max | money_without_trailing_zeros }}</span></del>
              
              {% endif %}

              
              {% if product.price_varies %} from {{ product.price_min | money_without_trailing_zeros }} {% else %} {{ product.price | money_without_trailing_zeros }} {% endif %}
            </p>

            {% form 'product', product, class:"product-form, id:"AddToCartForm %}
                <div class="mb-3">
                    <select name="id" id="productSelect" class="form-select">
                        {% assign availability_count = 0 %}    

                        {% for variant in product.variants %}
                            {% if variant.available %}
                                {% assign availability = availability_count | plus: 1 %}
                                {% if variant.compare_at_price > 0 %}
                                  {% assign priceold = variant.compare_at_price | money_without_trailing_zeros  %}
                                  {% assign pricenew = variant.price | money_without_trailing_zeros  %}
                                  {% assign desc = variant.title | append : ' - ( was ' | append : priceold  | append : ' ) now ' | append : pricenew %}
                                {% else %}
                                  {% assign pricenew = variant.price | money_without_trailing_zeros  %}
                                  {% assign desc = variant.title | append : ' ' | append : pricenew %}
                                {% endif %}
                                <option value="{{ variant.id }}">{{ desc }}</option>
                            {% else %}
                                <option value="{{ variant.id }}" disabled="disabled"> {{ variant.title }}</option>
                            {% endif %}                       
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3 form-group form-inline">
                  <label for="Quantity">Quantity</label>
                    <input type="number" class="form-control form-inline" name="quantity" id="Quantity" value="1" min="1">
                </div>
                <button type="submit" name="add" id="AddToCart" class="btn-add-to-cart w-100" {% unless availability > 0 %} disabled="disabled" >Sold Out {% else %} >Add to Cart {% endunless %}</button>
                <p></p>
                {% if section.settings.dynamic_button_checkbox== true %}                
                {{ form  | payment_button }}
                {% endif %}
              {% endform %}  
        </div>
      </div>
</section>

<!-- / element structure
<div id="product_recomm" class="container">
    <section id="product_recommendation" class="row content-justify-center my-5">
        <div class="text-center"><h1>Also in store</h1></div>
        <div class="row d-flex g-3 row-cols-lg-6 row-cols-md-4 row-cols-sm-3 row-cols-2 py-2" id="product_recommendation_body"></div>
    </section>
</div> 
/-->

<div id="productInfoModal" class="modal modalfade" tabIndex="-1" aria-hidden="true" style="z-index:2001;">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: none;user-select: none;">
              <h1 id="productInfoTitle" class="text-product-title"></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                      <div class="col-12 col-md-6">
                        <img class="img-fluid" style="min-height:50vh;height:480px;width:480px;" src="" id="productInfoImg" alt="">
                        <div id="badge"></div>
                      </div>
                      <div class="col-12 col-md-6">
                        <p class="text-header-title" id="productInfoPrice" class="text-product-desc"></p>
                        <p id="productInfoDescription" class="text-product-desc"></p>
                        <div id="star-badge"></div>
                        <div id="award-badge"></div>
                      </div>
                </div>             
            </div>
            <div class="modal-footer" style="border-top: none;">
              <div class="col-12 col-md-6"></div>
              <div class="col-12 col-md-6 px-2">
                <form action="#" id="addToCartForm" class="row">
                  <select name="id" id="modalItemID" class="form-select col-auto">
                  </select>
                  <p></p>
                  <div class="row">
                      <input type="number" name="quantity" label="Quantity" value="1" id="modalItemQuantity" min="1" max="9999" class="col-auto w-100">    
                      <p></p>           
                      <button type="submit" id="btnAddToCart" class="btn-add-to-cart col-auto w-100">Add to Cart</button>                
                  </div>    
                  <p></p>
                </form>
              </div>
            </div>
        </div>
    </div>
</div>

<style scoped>
  input {
    border-left: none !important;
    border-right: none !important;
    border-top: none !important;
    border-bottom: 1px solid #ced4da !important;
  }
  
  .form-select {
      border-left: none;
      border-right: none;
      border-top: none;
  }  


  .icon {
    height: 30px;
    width: 30px;
    fill: transparent;
    stroke: #11171B;
    transition: fill 0.3s ease;
  }

  .active .icon {
    fill: #F652A0;
    stroke: transparent;
  }

  .snippet-wishlist {
    position: relative;
    padding-top: 10px;
    padding-bottom: 10px;
  }  
</style>
<script>  
new Swiper(".swiper-container-{{- product.id -}}", {
    slidesPerView: 1,
    centeredSlides: true,
    effect: "fade",
    loop: true,
    observer: true, 
    observeParents: true,  
    navigation: {
      prevEl: ".swiper-button-prev-{{- product.id -}}",
      nextEl: ".swiper-button-next-{{- product.id -}}"
    }    
  })
  
    //var productRecommendationBody = document.getElementById('product_recommendation_body');
    fetch('/recommendations/products.json?product_id={{ product.id }}')
    .then(resp => resp.json())
    .then(({ products }) =>{
        
        var arrProducts = Array.from(products);
        //console.log(arrProducts);
        //add eventlistener, later to be dispatched when new element build (product recommendation) completed
        arrProducts.forEach( function (el) {
            //console.log(el);
            document.addEventListener( 'dispatchPrd', function ( event ) {
                //console.log(`registering productInfoAnchor ${el.id}`);
                getProductAnchors(`productInfoAnchor-${el.id}`);
              });
        })
               
        //console.log(products);
        if(products.length > 0) {
        
            /* element 
                <div class="container">
                    <section id="product_recommendation" class="row content-justify-center my-5">
                        <div class="text-center"><h1>Also in store</h1></div>
                        <div class="row d-flex g-3 row-cols-lg-6 row-cols-md-4 row-cols-sm-3 row-cols-2 py-2" id="product_recommendation_body"></div>
                    </section>
                </div>
            */

            const htmlMarkup = `
                 <section id="product_recommendation" class="content-justify-center my-5">
                    <div class="text-center"><h1>Also in store</h1></div>
                    <div class="d-flex flex-wrap g-3 row row-cols row-cols-xl-4 row-cols-lg-3 row-cols-md-2 row-cols-sm-1 row-cols-1 py-2" id="product_recommendation_body">
            `;

            html = htmlMarkup.trim();
            var productRecomm = document.createElement('div');
            productRecomm.className = 'container';
            
            products.forEach(function(item,index) {

            //console.log(item);
            arrProducts[item] = `productInfoAnchor-${item.id}`;
            

            let prdPrice = formatCcy((+item.price / 100));                   
            let prdPriceMin = formatCcy((+item.price_min / 100));                   
            let prdComparePrice = formatCcy((+item.compare_at_price_max / 100));                   
            let from = '';

            if (item.price_varies) from = `from `;

            var card, iconstyle;

            card = `<div class="col d-flex">`;
            card += `<div class="img-wrapper d-flex">`;
            card += `<div class="card d-flex flex-fill border-0 shadow-sm">`;

            if(item.images.length > 0) {
                card += `<div class="inner-img">`;
                card += `<a href="javascript:;"   id="productInfoAnchor-${item.id}" product-handle="${item.handle}" 
                        product-price="${from} ${prdPrice}"><img class="card-img-top" width="640" height="360" src="${item.images[0]}" alt="${item.title}"></a>`;
                card += `<div class="text-hover">QUICK SHOP</div></div>`;
            }          
            card += `<div class="card-body d-flex flex-column justify-content-end text-center bg-light pb-0">`;
            card += `<a class="text-product-link" style="font-size:1.25rem;" href="${item.url}">${item.title}</a>`;
            card += `<p span class="text-line"></p>`;

            if (item.compare_at_price_max > 0 ) { 

              card += `<p>{% render 'discount', product : product %}<svg class="tag-badge">{% render 'tag-badge' %} </svg>
                <del><span style="color: #AB0000;">${prdComparePrice}</span></del> ${from} ${prdPrice}</p>`;

               
            } else {
              card += `<p>${from} ${prdPriceMin}</p>`;     
            }
            
            card += `<button type="button" aria-label="Add to wishlist" class="wishlist-badge" button-wishlist data-product-handle="${item.handle}"><svg class="icon">{% render 'heart-badge' %}</svg></button>`;

            if (item.tags.includes('Special')) {
              card += `<div><svg class="star-badge">{% render 'star-badge' %}</svg></div>`; 
              iconstyle = ``;

            } else {
              iconstyle = `style="transform: translateX(-35px);"`;
            }

            if (item.tags.includes('Award')) {
              card += `<div><svg class="award-badge" ${iconstyle}>{% render 'award-badge' %}</svg></div>`; 
            }

            card += `</div></div></div></div>`;
            
            html += card;                           

        });
        
        html += `</div></section>`;

        productRecomm.innerHTML = html;  
         
        //insert element after "product_details"
        const reference = document.getElementById("product_details");        
        reference.after(productRecomm);
        
        var wishlistSnippet =  document.createElement('div');   
        wishlistSnippet.className = 'snippet-wishlist';

        wishlistcard = `<button type="button" aria-label="Add to wishlist" class="wishlist-badge" button-wishlist data-product-handle="{{product.handle}}"><svg class="icon">{% render 'heart-badge' %}</svg></button>`;     

        wishlistSnippet.innerHTML = wishlistcard;

        const referenceTitle = document.getElementById("prd-title");        
        referenceTitle.after(wishlistSnippet);
        
        // Create a custom event and dispatch to setup PopUp Modal 
        let myEvent = new CustomEvent('dispatchPrd', {
	        bubbles: true,
	        cancelable: true
            });

        setTimeout(()=>{
            const body = document.body;
            document.dispatchEvent(myEvent);     
            initButtons();       
          },2)

        clearTimeout();
        }     
    });
 
     function formatCcy(amount) {
        var ccyTemp = parseFloat(amount).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
      
        //remove trailing zeros
        var ccyFormated =
          ccyTemp.slice(-3) === '.00'
            ? ccyTemp.slice(0, -3)
            : ccyTemp.slice(-1) === '0'
            ? ccyTemp.slice(0, -1)
            : ccyTemp;
        return ccyFormated;
      }

    var PrdTemplate;
 
    window.addEventListener('load', 
        function() { 
          checkLocaleBtn();         
        }, false);       

</script>
{% schema %}
{
    "name": "product pages",
    "settings": [
    {
        "type": "checkbox",
        "id": "dynamic_button_checkbox",
        "label": "Enable Dynamic Buy Button",
        "default": false
    }]
}
{% endschema %}


 
{% comment %}theme-check-enable{% endcomment %}
